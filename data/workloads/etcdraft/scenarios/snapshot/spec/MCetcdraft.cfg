SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3
    s4 = s4
    s5 = s5
    s6 = s6

    InitServer  = {s1, s2}
    Server      = {s1, s2, s3, s4}

    v1 = v1
    v2 = v2
    v3 = v3
    Value       = {v1, v2}

    \* Constraint limits - tuned for tractable state space
    ReconfigurationLimit    = 2
    MaxTermLimit            = 4
    MaxTimeoutLimit         = 6
    RequestLimit            = 6

    \* Fault injection limits
    RestartLimit            = 1
    DropLimit               = 4
    DuplicateLimit          = 0
    StepDownLimit           = 2
    HeartbeatLimit          = 8

    \* Snapshot limits
    SnapshotLimit           = 2
    CompactLimit            = 2

    \* Config change limits
    ConfChangeLimit         = 2

    \* ReportUnreachable limit
    ReportUnreachableLimit  = 1

    \* Flow control
    MaxInflightMsgs         = 4

    \* FIFO message ordering - when TRUE, enforces FIFO delivery per (source, dest) pair
    MsgNoReorder            = FALSE

    \* Network partition configuration
    MaxPartitions           = 2     \* Maximum number of partition groups (2 = split into 2 groups)
    RestartDropsMessages    = FALSE \* When TRUE, Restart drops all messages to/from the node
    PartitionLimit          = 0     \* Maximum number of partition/heal cycles

    \* Message buffer limit for state space pruning
    MaxMsgBufferLimit       = 12
    
    \* Pending messages buffer limit for state space pruning
    MaxPendingMsgLimit      = 12

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil

    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry

    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader

    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    SnapshotStatus          = SnapshotStatus

    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry
\* VIEW ModelView

CHECK_DEADLOCK
    FALSE

\* ============================================================================
\* State Space Pruning Constraints
\* ============================================================================
CONSTRAINT
    MsgBufferConstraint
    PendingMsgBufferConstraint

\* ============================================================================
\* Core Raft Safety Invariants
\* ============================================================================
INVARIANTS
    LogInv
    MoreThanOneLeaderInv
    ElectionSafetyInv
    LogMatchingInv
    QuorumLogInv
    MoreUpToDateCorrectInv
    LeaderCompletenessInv
    CommittedIsDurableInv

\* ============================================================================
\* Progress and Inflights Invariants
\* ============================================================================
INVARIANTS
    \* Flow Control Safety
    ProbeLimitInv
    ReplicatePauseInv
    SnapshotInflightsInv

    \* Inflights Data Integrity
    InflightsLogIndexInv
    InflightsMatchIndexInv
    InflightsMonotonicInv

    \* Progress State Consistency
    ProgressStateTypeInv
    InflightsInv
    SnapshotPendingInv
    NoPendingSnapshotInv
    LeaderSelfReplicateInv
    SnapshotStateInv

    \* Fundamental Progress Invariants
    MatchIndexLessThanLogInv
    MatchIndexNonNegativeInv
    InflightsAboveMatchInv
    MatchIndexLessThanNextInv
    MsgAppFlowPausedConsistencyInv
    ProbeOneInflightMaxInv
    SnapshotNoInflightsStrictInv

\* ============================================================================
\* Additional Safety Invariants
\* ============================================================================
INVARIANTS
    AllMessageTermsValid
    MessageIndexValidInv
    StateMachineConsistency
    CommitIndexBoundInv
    CommittedEntriesTermInv
    PendingConfigBoundInv
    LeaderLogLengthInv
    LogTermMonotonic
    CurrentTermAtLeastLogTerm
    CandidateVotedForSelfInv
    DurableStateConsistency
    MessageEndpointsValidInv
    LeaderDurableTermInv

\* ============================================================================
\* NEW: P0 Log Structure Invariants
\* ============================================================================
INVARIANTS
    LogOffsetMinInv
    SnapshotOffsetConsistencyInv
    SnapshotTermValidInv
    SnapshotTermBoundInv
    HistoryLogLengthInv
    SnapshotCommitConsistencyInv

\* ============================================================================
\* NEW: P1 Configuration Invariants
\* ============================================================================
INVARIANTS
    JointConfigNonEmptyInv
    SingleConfigOutgoingEmptyInv
    LearnersVotersDisjointInv
    ConfigNonEmptyInv
    PendingConfIndexValidInv

\* ============================================================================
\* NEW: P1 Additional Progress Invariants
\* ============================================================================
INVARIANTS
    NextIndexPositiveInv
    NextIndexBoundInv
    MatchIndexBoundInv
    LeaderMatchSelfInv
    LeaderNextSelfInv
    PendingSnapshotBoundInv

\* ============================================================================
\* NEW: P2 Message Content Invariants
\* ============================================================================
INVARIANTS
    SnapshotMsgIndexValidInv
    SnapshotMsgTermValidInv
    AppendEntriesPrevIndexNonNegInv
    AppendEntriesCommitBoundInv
    VoteRequestLogIndexNonNegInv
    VoteRequestLogTermNonNegInv
    AppendEntriesTermConsistentInv
    SnapshotMsgIndexPositiveInv
    ResponseTermPositiveInv

\* ============================================================================
\* NEW: P2 Inflights Refined Invariants
\* ============================================================================
INVARIANTS
    InflightsOnlyInReplicateInv
    InflightsBelowNextInv

\* ============================================================================
\* NEW: P3 Term and Vote Invariants
\* ============================================================================
INVARIANTS
    TermPositiveInv
    LeaderTermPositiveInv
    CandidateTermPositiveInv
    VotesRespondedSubsetInv
    VotesGrantedSubsetInv

\* ============================================================================
\* BUG DETECTION INVARIANTS
\* These are designed to detect specific known bugs from etcd/raft git history.
\* ============================================================================
INVARIANTS
    \* Bug 76f1249: MsgApp after log truncation causes panic
    \* prevLogTerm should never be 0 when prevLogIndex > 0
    AppendEntriesPrevLogTermValidInv

    \* Bug bd3c759: Auto-transitioning out of joint config multiple attempts
    \* At most one pending leave-joint entry in uncommitted log
    SinglePendingLeaveJointInv
    \* pendingConfIndex should be updated when auto-leave is proposed
    PendingConfIndexAutoLeaveInv

    \* Bug 8ecce32: CommittedEntries pagination correctness (general safety property)
    CommittedEntriesConsistentInv

\* ============================================================================
\* P0: CRITICAL INVARIANTS - Known to cause panics in etcd
\* Reference: etcd issues #10166, #17081
\* ============================================================================
INVARIANTS
    \* applied <= committed (log.go:46)
    AppliedBoundInv
    \* commitIndex <= lastIndex (log.go:324) - the "tocommit out of range" panic
    CommitIndexBoundInv
    \* Message destination must be valid server
    MessageDestinationValidInv

\* ============================================================================
\* P1: HIGH PRIORITY INVARIANTS - Prevent data corruption
\* ============================================================================
INVARIANTS
    \* nextIndex >= log.offset after compaction (Bug 76f1249 related)
    LeaderNextIndexValidInv
    \* snapshotIndex <= applied
    SnapshotAppliedConsistencyInv

\* ============================================================================
\* P2: DETAILED INVARIANTS - Catch subtle inconsistencies
\* ============================================================================
INVARIANTS
    \* Entries in MsgApp must exist in leader's log
    AppendEntriesSourceValidInv
    \* MsgApp's commitIndex <= leader's commitIndex
    HeartbeatCommitBoundInv
    \* appliedConfigIndex <= commitIndex
    AppliedConfigBoundInv

\* ============================================================================
\* P3: CODE-DERIVED INVARIANTS - Directly from raft source code
\* ============================================================================
INVARIANTS
    \* StateSnapshot => Next == PendingSnapshot + 1 (progress.go:40)
    StateSnapshotNextInv
    \* pendingConfIndex > 0 => pendingConfIndex > applied (raft.go:1320)
    ConfigChangePendingInv

\* ============================================================================
\* P4: VERDI-RAFT INSPIRED INVARIANTS
\* Source: https://github.com/uwplse/verdi-raft (Coq proof of Raft)
\* ============================================================================
INVARIANTS
    \* votedFor is valid server when set
    VotedForConsistencyInv
    \* Entries with leader's current term must exist in leader's log
    LeaderCurrentTermEntriesInv
    \* RequestVote messages have valid term bounds
    RequestVoteTermBoundInv
    \* AppendEntries responses have positive terms
    AppendEntriesResponseTermInv
    \* Leader's log contains all committed entries
    LeaderLogContainsAllCommittedInv
    \* Snapshot responses have positive terms
    SnapshotResponseTermValidInv

\* ============================================================================
\* P5: GIT HISTORY BUG PREVENTION INVARIANTS
\* Source: etcd/raft git commit history analysis
\* ============================================================================
INVARIANTS
    \* No term=0 entries in log
    TermNeverZeroInLogInv
    \* snapshotIndex > 0 => snapshotTerm > 0
    SnapshotTermNeverZeroInv

PROPERTIES
    MonotonicCommitIndexProp
    MonotonicTermProp
    MonotonicMatchIndexProp