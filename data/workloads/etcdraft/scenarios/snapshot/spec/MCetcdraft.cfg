SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = 1
    s2 = 2
    s3 = 3
    s4 = 4
    s5 = 5

    InitServer  = {s1, s2, s3}
    Server      = {s1, s2, s3, s4, s5}

    \* Constraint limits - tuned for tractable state space
    ReconfigurationLimit    = 2
    MaxTermLimit            = 4
    RequestLimit            = 2

    \* Fault injection limits
    RestartLimit            = 2
    DropLimit               = 2
    DuplicateLimit          = 2
    StepDownLimit           = 2
    HeartbeatLimit          = 8

    \* Snapshot limits
    SnapshotLimit           = 3
    CompactLimit            = 3

    \* Config change limits
    ConfChangeLimit         = 2

    \* ReportUnreachable limit
    ReportUnreachableLimit  = 2

    \* Flow control
    MaxInflightMsgs         = 4

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = 0

    ValueEntry  = "ValueEntry"
    ConfigEntry = "ConfigEntry"

    Follower    = "Follower"
    Candidate   = "Candidate"
    Leader      = "Leader"

    RequestVoteRequest      = "RequestVoteRequest"
    RequestVoteResponse     = "RequestVoteResponse"
    AppendEntriesRequest    = "AppendEntriesRequest"
    AppendEntriesResponse   = "AppendEntriesResponse"
    SnapshotRequest         = "SnapshotRequest"
    SnapshotResponse        = "SnapshotResponse"
    SnapshotStatus          = "SnapshotStatus"

    StateProbe      = "StateProbe"
    StateReplicate  = "StateReplicate"
    StateSnapshot   = "StateSnapshot"

SYMMETRY Symmetry
VIEW ModelView

CHECK_DEADLOCK
    FALSE

\* ============================================================================
\* Core Raft Safety Invariants
\* ============================================================================
INVARIANTS
    LogInv
    MoreThanOneLeaderInv
    ElectionSafetyInv
    LogMatchingInv
    QuorumLogInv
    MoreUpToDateCorrectInv
    LeaderCompletenessInv
    CommittedIsDurableInv

\* ============================================================================
\* Progress and Inflights Invariants
\* ============================================================================
INVARIANTS
    \* Flow Control Safety
    ProbeLimitInv
    ReplicatePauseInv
    SnapshotInflightsInv

    \* Inflights Data Integrity
    InflightsLogIndexInv
    InflightsMatchIndexInv
    InflightsMonotonicInv

    \* Progress State Consistency
    ProgressStateTypeInv
    InflightsInv
    SnapshotPendingInv
    NoPendingSnapshotInv
    LeaderSelfReplicateInv
    SnapshotStateInv

    \* Fundamental Progress Invariants
    MatchIndexLessThanLogInv
    MatchIndexNonNegativeInv
    InflightsAboveMatchInv
    MatchIndexLessThanNextInv
    SnapshotNextInv
    MsgAppFlowPausedConsistencyInv
    ProbeOneInflightMaxInv
    SnapshotNoInflightsStrictInv

\* ============================================================================
\* Additional Safety Invariants
\* ============================================================================
INVARIANTS
    AllMessageTermsValid
    MessageIndexValidInv
    StateMachineConsistency
    CommitIndexBoundInv
    CommittedEntriesTermInv
    PendingConfigBoundInv
    LeaderLogLengthInv
    LogTermMonotonic
    CurrentTermAtLeastLogTerm
    VotedForInConfigInv
    CandidateVotedForSelfInv
    DurableStateConsistency
    MessageEndpointsValidInv
    LeaderDurableTermInv
