SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3

    \* Start with 2 servers, add s3 via config change
    InitServer  = {s1, s2}
    Server      = {s1, s2, s3}

    v1 = v1
    Value       = {v1}

    \* Limits for bug 7280 reproduction - OPTIMIZED
    \* Need: config committed but not applied, then Timeout
    ReconfigurationLimit    = 1
    MaxTermLimit            = 5      \* Need enough terms for multiple elections
    MaxTimeoutLimit         = 5      \* Need enough timeouts: election + bug trigger
    RequestLimit            = 0      \* Not needed for this bug

    \* Fault injection - minimal
    RestartLimit            = 0      \* Not needed
    DropLimit               = 0      \* Not needed
    DuplicateLimit          = 0
    StepDownLimit           = 0      \* Not needed
    HeartbeatLimit          = 5

    \* Snapshot and compaction - not needed
    SnapshotLimit           = 0
    CompactLimit            = 0

    \* Config changes - CRITICAL for this bug
    ConfChangeLimit         = 1      \* One config change is enough

    \* Other limits
    ReportUnreachableLimit  = 0
    MaxInflightMsgs         = 2
    MsgNoReorder            = FALSE

    \* Network - not needed
    MaxPartitions           = 1
    RestartDropsMessages    = FALSE
    PartitionLimit          = 0

    \* Message buffer
    MaxMsgBufferLimit       = 10
    MaxPendingMsgLimit      = 10

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil
    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry
    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader
    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry

CHECK_DEADLOCK
    FALSE

CONSTRAINT
    MsgBufferConstraint
    PendingMsgBufferConstraint

\* ============================================================================
\* BUG DETECTION INVARIANT - This should be VIOLATED
\* Bug 7280: Candidate can start election with committed but unapplied config
\* The bug is that Timeout doesn't wait for all configs to be applied
\* This allows wrong quorum to be used during election
\* ============================================================================
INVARIANT
    ElectionConfigAppliedInv
