SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3

    InitServer  = {s1, s2, s3}
    Server      = {s1, s2, s3}

    v1 = v1
    Value       = {v1}

    \* Limits for bug 124 reproduction
    \* Need snapshot operations to trigger StateSnapshot state
    ReconfigurationLimit    = 1
    MaxTermLimit            = 2
    MaxTimeoutLimit         = 3
    RequestLimit            = 5

    \* Fault injection
    RestartLimit            = 1
    DropLimit               = 3
    DuplicateLimit          = 0
    StepDownLimit           = 0
    HeartbeatLimit          = 5

    \* Snapshot and compaction - CRITICAL for this bug
    SnapshotLimit           = 3
    CompactLimit            = 3

    \* Config changes
    ConfChangeLimit         = 1

    \* Other limits
    ReportUnreachableLimit  = 1
    MaxInflightMsgs         = 2
    MsgNoReorder            = FALSE

    \* Network
    MaxPartitions           = 1
    RestartDropsMessages    = FALSE
    PartitionLimit          = 1

    \* Message buffer
    MaxMsgBufferLimit       = 10
    MaxPendingMsgLimit      = 10

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil
    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry
    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader
    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry

CHECK_DEADLOCK
    FALSE

CONSTRAINT
    MsgBufferConstraint
    PendingMsgBufferConstraint

\* ============================================================================
\* BUG DETECTION INVARIANT - This should be VIOLATED
\* Bug 124: Progress state transition uses = instead of >= for pendingSnapshot check
\* This causes follower to get stuck in StateSnapshot when matchIndex exceeds pendingSnapshot
\* ============================================================================
INVARIANT
    SnapshotTransitionCorrectInv
