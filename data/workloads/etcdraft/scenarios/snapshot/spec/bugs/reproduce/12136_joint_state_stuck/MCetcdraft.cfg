SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3

    InitServer  = {s1, s2}
    Server      = {s1, s2, s3}

    v1 = v1
    Value       = {v1}

    \* Limits for bug 12136 reproduction
    \* Need config changes and leader restart to trigger the bug
    ReconfigurationLimit    = 2
    MaxTermLimit            = 3
    MaxTimeoutLimit         = 5
    RequestLimit            = 2

    \* Fault injection - CRITICAL: Need restart to trigger new leader in joint config
    RestartLimit            = 2
    DropLimit               = 1
    DuplicateLimit          = 0
    StepDownLimit           = 1
    HeartbeatLimit          = 3

    \* Snapshot and compaction
    SnapshotLimit           = 1
    CompactLimit            = 1

    \* Config changes - CRITICAL for this bug
    ConfChangeLimit         = 2

    \* Other limits
    ReportUnreachableLimit  = 0
    MaxInflightMsgs         = 2
    MsgNoReorder            = FALSE

    \* Network
    MaxPartitions           = 1
    RestartDropsMessages    = FALSE
    PartitionLimit          = 1

    \* Message buffer
    MaxMsgBufferLimit       = 10
    MaxPendingMsgLimit      = 10

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil
    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry
    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader
    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry

CHECK_DEADLOCK
    FALSE

CONSTRAINT
    MsgBufferConstraint
    PendingMsgBufferConstraint

\* ============================================================================
\* BUG DETECTION INVARIANT - This should be VIOLATED
\* Bug 12136: Joint state stuck when new leader elected in joint config
\* The new leader sets pendingConfChangeIndex = lastIndex, and the buggy condition
\* `pendingConfChangeIndex < lastIndex` is never satisfied, blocking AutoLeave
\* ============================================================================
INVARIANT
    JointStateAutoLeavePossibleInv
