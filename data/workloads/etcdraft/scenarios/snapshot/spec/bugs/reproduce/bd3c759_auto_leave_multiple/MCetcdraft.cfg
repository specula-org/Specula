SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3

    InitServer  = {s1, s2}
    Server      = {s1, s2, s3}

    v1 = v1
    Value       = {v1}

    \* Limits for bug bd3c759 reproduction - OPTIMIZED
    \* Need config changes to trigger joint config
    ReconfigurationLimit    = 1
    MaxTermLimit            = 2
    MaxTimeoutLimit         = 2
    RequestLimit            = 0      \* Not needed for this bug

    \* Fault injection - minimal
    RestartLimit            = 0
    DropLimit               = 0      \* Not needed for this bug
    DuplicateLimit          = 0
    StepDownLimit           = 0
    HeartbeatLimit          = 2

    \* Snapshot and compaction - not needed
    SnapshotLimit           = 0
    CompactLimit            = 0

    \* Config changes - CRITICAL for this bug
    ConfChangeLimit         = 1      \* One ChangeConf to enter joint

    \* Other limits
    ReportUnreachableLimit  = 0
    MaxInflightMsgs         = 2
    MsgNoReorder            = FALSE

    \* Network
    MaxPartitions           = 1
    RestartDropsMessages    = FALSE
    PartitionLimit          = 0

    \* Message buffer
    MaxMsgBufferLimit       = 10
    MaxPendingMsgLimit      = 10

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil
    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry
    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader
    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry

CHECK_DEADLOCK
    FALSE

CONSTRAINT
    MsgBufferConstraint
    PendingMsgBufferConstraint

\* ============================================================================
\* BUG DETECTION INVARIANT - This should be VIOLATED
\* Bug bd3c759: Auto-transitioning out of joint config launches multiple attempts
\* At most one pending leave-joint entry should exist in uncommitted log
\* ============================================================================
INVARIANT
    SinglePendingLeaveJointInv
