SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = s1
    s2 = s2
    s3 = s3
    s4 = s4
    s5 = s5
    s6 = s6

    InitServer  = {s1, s2, s3}
    Server      = {s1, s2, s3, s4, s5, s6}

    v1 = v1
    v2 = v2
    v3 = v3
    Value       = {v1, v2, v3}

    \* Constraint limits - tuned for tractable state space
    ReconfigurationLimit    = 3
    MaxTermLimit            = 6
    MaxTimeoutLimit         = 8
    RequestLimit            = 6

    \* Fault injection limits
    RestartLimit            = 1
    DropLimit               = 6
    DuplicateLimit          = 1
    StepDownLimit           = 3
    HeartbeatLimit          = 12

    \* Snapshot limits
    SnapshotLimit           = 3
    CompactLimit            = 3

    \* Config change limits
    ConfChangeLimit         = 3

    \* ReportUnreachable limit
    ReportUnreachableLimit  = 2

    \* Flow control
    MaxInflightMsgs         = 5

    \* Action overrides
    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    ClientRequestAndSend <- MCClientRequestAndSend
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    SendSnapshot        <- MCSendSnapshot
    CompactLog          <- MCCompactLog
    ChangeConf          <- MCChangeConf
    ChangeConfAndSend   <- MCChangeConfAndSend
    ManualSendSnapshot  <- MCManualSendSnapshot
    SendSnapshotWithCompaction <- MCSendSnapshotWithCompaction
    ReportUnreachable   <- MCReportUnreachable

    \* Initialization overrides
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars
    InitDurableState <- etcdInitDurableState

    \* Type constants
    Nil = Nil

    ValueEntry  = ValueEntry
    ConfigEntry = ConfigEntry

    Follower    = Follower
    Candidate   = Candidate
    Leader      = Leader

    RequestVoteRequest      = RequestVoteRequest
    RequestVoteResponse     = RequestVoteResponse
    AppendEntriesRequest    = AppendEntriesRequest
    AppendEntriesResponse   = AppendEntriesResponse
    SnapshotRequest         = SnapshotRequest
    SnapshotResponse        = SnapshotResponse
    SnapshotStatus          = SnapshotStatus

    StateProbe      = StateProbe
    StateReplicate  = StateReplicate
    StateSnapshot   = StateSnapshot

SYMMETRY Symmetry
\* VIEW ModelView

CHECK_DEADLOCK
    FALSE

\* ============================================================================
\* Core Raft Safety Invariants
\* ============================================================================
INVARIANTS
    LogInv
    MoreThanOneLeaderInv
    ElectionSafetyInv
    \* LogMatchingInv
    \* QuorumLogInv
    MoreUpToDateCorrectInv
    LeaderCompletenessInv
    CommittedIsDurableInv

\* ============================================================================
\* Progress and Inflights Invariants
\* ============================================================================
INVARIANTS
    \* Flow Control Safety
    ProbeLimitInv
    ReplicatePauseInv
    SnapshotInflightsInv

    \* Inflights Data Integrity
    InflightsLogIndexInv
    InflightsMatchIndexInv
    InflightsMonotonicInv

    \* Progress State Consistency
    ProgressStateTypeInv
    InflightsInv
    SnapshotPendingInv
    NoPendingSnapshotInv
    LeaderSelfReplicateInv
    SnapshotStateInv

    \* Fundamental Progress Invariants
    MatchIndexLessThanLogInv
    MatchIndexNonNegativeInv
    InflightsAboveMatchInv
    MatchIndexLessThanNextInv
    SnapshotNextInv
    MsgAppFlowPausedConsistencyInv
    ProbeOneInflightMaxInv
    SnapshotNoInflightsStrictInv

\* ============================================================================
\* Additional Safety Invariants
\* ============================================================================
INVARIANTS
    AllMessageTermsValid
    MessageIndexValidInv
    StateMachineConsistency
    CommitIndexBoundInv
    CommittedEntriesTermInv
    PendingConfigBoundInv
    LeaderLogLengthInv
    LogTermMonotonic
    CurrentTermAtLeastLogTerm
    CandidateVotedForSelfInv
    \* DurableStateConsistency
    MessageEndpointsValidInv
    LeaderDurableTermInv

\* ============================================================================
\* NEW: P0 Log Structure Invariants
\* ============================================================================
INVARIANTS
    LogOffsetMinInv
    SnapshotOffsetConsistencyInv
    SnapshotTermValidInv
    SnapshotTermBoundInv
    \* HistoryLogLengthInv
    SnapshotCommitConsistencyInv

\* ============================================================================
\* NEW: P1 Configuration Invariants
\* ============================================================================
INVARIANTS
    \* JointConfigNonEmptyInv
    SingleConfigOutgoingEmptyInv
    \* LearnersVotersDisjointInv
    \* ConfigNonEmptyInv
    \* PendingConfIndexValidInv

\* ============================================================================
\* NEW: P1 Additional Progress Invariants
\* ============================================================================
INVARIANTS
    NextIndexPositiveInv
    NextIndexBoundInv
    MatchIndexBoundInv
    LeaderMatchSelfInv
    LeaderNextSelfInv
    PendingSnapshotBoundInv

\* ============================================================================
\* NEW: P2 Message Content Invariants
\* ============================================================================
INVARIANTS
    SnapshotMsgIndexValidInv
    SnapshotMsgTermValidInv
    AppendEntriesPrevIndexNonNegInv
    AppendEntriesCommitBoundInv
    VoteRequestLogIndexNonNegInv
    VoteRequestLogTermNonNegInv
    AppendEntriesTermConsistentInv
    SnapshotMsgIndexPositiveInv
    ResponseTermPositiveInv

\* ============================================================================
\* NEW: P2 Inflights Refined Invariants
\* ============================================================================
INVARIANTS
    InflightsOnlyInReplicateInv
    InflightsBelowNextInv

\* ============================================================================
\* NEW: P3 Term and Vote Invariants
\* ============================================================================
INVARIANTS
    TermPositiveInv
    LeaderTermPositiveInv
    CandidateTermPositiveInv
    VotesRespondedSubsetInv
    VotesGrantedSubsetInv

PROPERTIES 
    MonotonicCommitIndexProp
    \* MonotonicTermProp
    \* MonotonicMatchIndexProp