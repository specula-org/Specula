SPECIFICATION mc_etcdSpec

CONSTANTS
    s1 = 1
    s2 = 2
    s3 = 3
    s4 = 4
    s5 = 5

    InitServer  = {s1, s2, s3}
    Server      = {s1, s2, s3, s4, s5}              \* 3 nodes (reduce combinations)

    ReconfigurationLimit    = 2             \* Keep config changes! But limit count
    MaxTermLimit            = 4             \* Reduce terms (4 is enough to test election)
    RequestLimit            = 2             \* Reduce requests

    \* Aggressive fault injection limitation (core state space reduction point)
    RestartLimit            = 2
    DropLimit               = 2
    DuplicateLimit          = 2
    StepDownLimit           = 2
    HeartbeatLimit          = 8

    MaxInflightMsgs         = 4             \* Keep 2 (test flow control)

    Timeout             <- MCTimeout
    Send                <- MCSend
    ClientRequest       <- MCClientRequest
    AddNewServer        <- MCAddNewServer
    DeleteServer        <- MCDeleteServer
    AddLearner          <- MCAddLearner
    \* NEW: Override fault injection actions with limited versions
    Restart             <- MCRestart
    DropMessage         <- MCDropMessage
    DuplicateMessage    <- MCDuplicateMessage
    StepDownToFollower  <- MCStepDown
    Heartbeat           <- MCHeartbeat
    
    InitServerVars  <- etcdInitServerVars
    InitLogVars     <- etcdInitLogVars
    InitConfigVars  <- etcdInitConfigVars

    Nil = 0

    ValueEntry  = "ValueEntry"
    ConfigEntry = "ConfigEntry"

    Follower    = "Follower"
    Candidate   = "Candidate"
    Leader      = "Leader"
    RequestVoteRequest      =   "RequestVoteRequest"
    RequestVoteResponse     =   "RequestVoteResponse"
    AppendEntriesRequest    =   "AppendEntriesRequest"
    AppendEntriesResponse   =   "AppendEntriesResponse"

    StateProbe      = "StateProbe"
    StateReplicate  = "StateReplicate"
    StateSnapshot   = "StateSnapshot"

SYMMETRY Symmetry
VIEW ModelView

CHECK_DEADLOCK 
    FALSE

INVARIANTS
    LogInv
    MoreThanOneLeaderInv
    ElectionSafetyInv
    LogMatchingInv
    QuorumLogInv
    MoreUpToDateCorrectInv
    LeaderCompletenessInv
    CommittedIsDurableInv
    \* AdditionalSafety
    \* Testing individual invariants to find the violation:
    AllMessageTermsValid
    MessageIndexValidInv
    StateMachineConsistency
    CommitIndexBoundInv
    CommittedEntriesTermInv
    PendingConfigBoundInv
    LeaderLogLengthInv
    LogTermMonotonic
    CurrentTermAtLeastLogTerm
    VotedForInConfigInv
    CandidateVotedForSelfInv
    DurableStateConsistency
    MessageEndpointsValidInv
    LeaderDurableTermInv
    \* Aggregate all Progress-related invariants
    \* ProbeLimitInv
    ReplicatePauseInv
    SnapshotInflightsInv
    InflightsLogIndexInv
    InflightsMatchIndexInv
    ProgressStateTypeInv
    InflightsInv
    SnapshotPendingInv
    NoPendingSnapshotInv
    LeaderSelfReplicateInv
    SnapshotStateInv
    InflightsMonotonicInv
    \* NEW: Additional strong invariants from code analysis
    MatchIndexLessThanLogInv
    MatchIndexNonNegativeInv
    InflightsAboveMatchInv
    MatchIndexLessThanNextInv
    SnapshotNextInv
    MsgAppFlowPausedConsistencyInv
    ProbeOneInflightMaxInv
    SnapshotNoInflightsStrictInv